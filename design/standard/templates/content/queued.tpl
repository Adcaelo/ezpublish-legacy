{* DO NOT EDIT THIS FILE! Use an override template instead. *}

{ezscript_require( array( 'ezjsc::yui3', 'ezjsc::yui3io' ) )}

<script type="text/javascript">
<!--
var contentObjectId = {$contentObjectId};
var version = {$version};
var ajaxUri = 'ezpublishingqueue::status::' + contentObjectId + '::' + version;
var publishQueueUpdater = false;
{* redirect uri posted in the content/edit form *}
var redirectUri={if is_set( $redirect_uri )}{$redirect_uri}{else}false{/if}

{literal}
YUI( YUI3_config ).use('node', 'io-ez', function( Y )
{
    Y.on( "contentready", function( e )
    {
        publishingQueueUpdateStatus();
        publishQueueUpdater = Y.later( 1000, null, publishingQueueUpdateStatus, null, true );
    }, '#publish-queue-status' );

    function publishingQueueUpdateStatus()
    {
        Y.io.ez( ajaxUri, {
            on: {success: function( id,r )
                {
                    if ( r.responseJSON.error_text )
                        Y.get( '#publish-queue-status-placeholder' ).setContent( r.responseJSON.error_text );
                    else
                    {
                        // publishing finished
                        status = r.responseJSON.content.status;

                        Y.get( '#publish-queue-status-placeholder' ).setContent( status );

                        if ( ( status == 'finished' ) )
                        {
                            if ( publishQueueUpdater != null )
                                publishQueueUpdater.cancel();

                            if ( redirectUri != false )
                            {
                                window.location = redirect_uri;
                            }
                            else
                            {
                                node_uri = r.responseJSON.content.node_uri;
                                Y.get( '#publish-queue-status-placeholder' ).setContent(
                                    '<a href="' + node_uri + '">Completed. View published node</a>'
                                );
                            }
                        }
                        // deferred to crontab
                        else if ( status == 'deferred' )
                        {
                            if ( publishQueueUpdater != null )
                                publishQueueUpdater.cancel();

                            console.log( r.responseJSON.content );
                            Y.get( '#publish-queue-status-placeholder' ).setContent
                            (
                                'Publishing has been deferred to crontab. It will be published when the operation resumes.<br />' +
                                '<a href="' + r.responseJSON.content.versionview_uri + '">View the pending item</a><br />' +
                                'The object will also be listed in your dashboard in the pending items block.<br />
                            );
                        }
                    }
                }
            }
        , method: 'GET'});
    }
});
{/literal}
// -->
</script>
<h1>Your content is being published</h1>

<div id="publish-queue-wait-text">Please wait while your content is being published</div>
<p />
<div id="publish-queue-status"><div id="publish-queue-status-placeholder" style="display: inline"></div></div>
