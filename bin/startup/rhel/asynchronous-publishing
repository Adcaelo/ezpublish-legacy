#!/bin/bash
#
# eZ Publish asychronous publishing init script for RHEL and CENTOS.
#
# Usage:
#
# Set the correct SOLR_HOME value, and copy this file to /etc/init.d
# Symlink to /etc/init.d/solr to /etc/rc3.d/S70ezpublish and /etc/rc5.d/S70publish
#
# Example:
# cp solr /etc/init.d/solr
# cd /etc/init.d && chmod 755 solr
# cd /etc/rc3.d && ln -s ../init.d/ezpublish S70ezpublish
# cd /etc/rc5.d && ln -s ../init.d/ezpublish S70ezpublish
# cd /etc/rc3.d && ln -s ../init.d/ezpublish K70ezpublish
# cd /etc/rc5.d && ln -s ../init.d/ezpublish K70ezpublish

DESC="eZ Publish asynchronous publishing"
NAME="ezpqp"
SYS_ID=ezpublish-async-engineering
EZ_HOME="/var/www/html/ezpublish" # Set solr home here (example: /var/www/ezpublish/extension/ezfind/java)
BIN_PATH=$EZ_HOME/bin/php/publishingqueueprocessor.php
PID_FILE="$EZ_HOME/var/run/asynchronous-publishing.pid"
USER=apache
OPTIONS="-n"

source /etc/rc.d/init.d/functions

RETVAL=0

d_start() {
    CURRENT_DIR=`pwd`
    cd $EZ_HOME
    daemon --user=$USER --check $NAME $BIN_PATH $OPTIONS > /dev/null 2>&1 &
    # daemon --user=$USER --check $NAME $BIN_PATH $OPTIONS
    RETVAL=$?
    cd $CURRENT_DIR
    [ $RETVAL -eq 0 ] && touch /var/lock/subsys/$NAME
    return $RETVAL
}

d_stop() {
    kill -TERM `cat $PID_FILE` >> /dev/null 2&>1
    RETVAL=$?
    [ $RETVAL -eq 0 ] && rm -f /var/lock/subsys/$NAME && rm -f $PID_FILE
    return $RETVAL
}

d_restart() {
    d_stop >> /dev/null 2&>1
    sleep 1
    d_start >> /dev/null 2&>1
}

d_reload() {
    killproc -p $PID_FILE -HUP 2&>1
    RETVAL=$?
    return $RETVAL
}

d_status() {
    status -p $PID_FILE $BIN_NAME >> /dev/null 2&>1
    return $?
}

case "$1" in
  start)
    echo " * Starting $DESC ($NAME)"
    d_status
    if [ $? -eq 0 ]
    then
      echo "   ...already running."
    else
      if d_start
      then
        echo "   ...done."
      else
        echo "   ...failed."
        RETVAL=1
      fi
    fi
    ;;
  stop)
    echo " * Stopping $DESC ($NAME)"
    if d_stop
    then
      echo "   ...done."
    else
      echo "   ...failed."
      RETVAL=1
    fi
    ;;
  restart)
    echo " * Restarting $DESC ($NAME)"
    d_status
    if [ $? -ne 0 ]
    then
      echo "   ...not running."
      RETVAL=1
    else
      if d_restart
      then
        echo " * ...done."
      else
        echo " * ...failed."
        RETVAL=1
      fi
    fi
    ;;
  reload)
    echo " * Reloading $DESC ($NAME): "
    d_reload
    echo "   ...done."
    ;;
  status)
    d_status
    if [ $? -eq 0 ]
    then
      echo " * $DESC ($NAME) is running"
    else
      echo " * $DESC ($NAME) is not running"
    fi
    ;;
  *)
    echo $"Usage: $0 {start|stop|restart|reload|status}"
    RETVAL=1
esac

exit $RETVAL
